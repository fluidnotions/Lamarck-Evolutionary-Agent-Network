# Agent Task: State Management

## Branch: `feature/state-management`

## Priority: HIGH - Needed by most components

## Execution: PARALLEL with feature/memory-system

## Objective
Implement type-safe state management for the HVAS Mini system using Pydantic and TypedDict, providing the state schema for LangGraph.

## Dependencies
- ✅ feature/project-foundation (must be merged first)

## Tasks

### 1. Create `src/hvas_mini/state.py`

Implement according to spec (section 3.1):

```python
"""
State management for HVAS Mini.

Defines the shared state structure used by LangGraph and all agents.
"""

from typing import TypedDict, Dict, List, Optional
from pydantic import BaseModel, Field
from datetime import datetime


class AgentMemory(BaseModel):
    """Individual agent memory record.

    Stored in ChromaDB and retrieved for context during generation.
    """
    content: str = Field(..., description="The generated content to remember")
    topic: str = Field(..., description="Topic this content relates to")
    score: float = Field(..., ge=0.0, le=10.0, description="Quality score (0-10)")
    timestamp: str = Field(
        default_factory=lambda: datetime.now().isoformat(),
        description="ISO timestamp of creation"
    )
    embeddings: Optional[List[float]] = Field(
        default=None,
        description="Vector embeddings for similarity search"
    )
    retrieval_count: int = Field(
        default=0,
        description="Number of times this memory has been retrieved"
    )

    class Config:
        """Pydantic configuration."""
        json_schema_extra = {
            "example": {
                "content": "Machine learning is a subset of artificial intelligence...",
                "topic": "machine learning basics",
                "score": 8.5,
                "timestamp": "2024-03-15T10:30:00",
                "retrieval_count": 3
            }
        }


class BlogState(TypedDict):
    """Shared state for blog generation workflow.

    This state is passed between nodes in the LangGraph workflow.
    All agents read from and write to this shared state.
    """

    # Content generated by agents
    topic: str  # Input topic for blog post
    intro: str  # Introduction section
    body: str   # Main body section
    conclusion: str  # Conclusion section

    # Evaluation scores (0-10 scale)
    scores: Dict[str, float]  # {"intro": 8.5, "body": 7.0, "conclusion": 9.0}

    # Memory and evolution tracking
    retrieved_memories: Dict[str, List[str]]  # Memories used by each agent
    parameter_updates: Dict[str, Dict[str, float]]  # Parameter changes per agent

    # Metadata
    generation_id: str  # Unique ID for this generation run
    timestamp: str  # ISO timestamp of generation start
    stream_logs: List[str]  # Activity logs for visualization


def create_initial_state(topic: str) -> BlogState:
    """Create initial state for a new blog generation.

    Args:
        topic: The topic to write about

    Returns:
        Initialized BlogState with empty values
    """
    import uuid

    return BlogState(
        topic=topic,
        intro="",
        body="",
        conclusion="",
        scores={},
        retrieved_memories={},
        parameter_updates={},
        generation_id=str(uuid.uuid4()),
        timestamp=datetime.now().isoformat(),
        stream_logs=[]
    )
```

### 2. Create Type Hints Helper

Add utility functions for type safety:

```python
def validate_state(state: BlogState) -> bool:
    """Validate that state has all required keys.

    Args:
        state: The state to validate

    Returns:
        True if valid, raises ValueError otherwise
    """
    required_keys = [
        "topic", "intro", "body", "conclusion", "scores",
        "retrieved_memories", "parameter_updates",
        "generation_id", "timestamp", "stream_logs"
    ]

    missing = [key for key in required_keys if key not in state]
    if missing:
        raise ValueError(f"State missing required keys: {missing}")

    return True
```

### 3. Add Tests

Create `test_state.py`:

```python
"""Tests for state management."""

from hvas_mini.state import AgentMemory, BlogState, create_initial_state, validate_state
import pytest


def test_agent_memory_creation():
    """Test AgentMemory model creation."""
    memory = AgentMemory(
        content="Test content",
        topic="test topic",
        score=8.5
    )

    assert memory.content == "Test content"
    assert memory.topic == "test topic"
    assert memory.score == 8.5
    assert memory.retrieval_count == 0
    assert memory.timestamp is not None


def test_agent_memory_validation():
    """Test AgentMemory score validation."""
    with pytest.raises(Exception):
        AgentMemory(
            content="Test",
            topic="test",
            score=11.0  # Invalid: > 10
        )


def test_create_initial_state():
    """Test initial state creation."""
    state = create_initial_state("machine learning")

    assert state["topic"] == "machine learning"
    assert state["intro"] == ""
    assert state["body"] == ""
    assert state["conclusion"] == ""
    assert state["generation_id"] != ""
    assert len(state["stream_logs"]) == 0


def test_validate_state():
    """Test state validation."""
    state = create_initial_state("test")
    assert validate_state(state) is True

    # Test missing key
    incomplete_state = {"topic": "test"}
    with pytest.raises(ValueError):
        validate_state(incomplete_state)
```

## Deliverables Checklist

- [ ] `src/hvas_mini/state.py` with:
  - [ ] `AgentMemory` Pydantic model
  - [ ] `BlogState` TypedDict
  - [ ] `create_initial_state()` function
  - [ ] `validate_state()` function
  - [ ] Complete docstrings
- [ ] `test_state.py` with passing tests
- [ ] Type hints on all functions
- [ ] Examples in docstrings

## Acceptance Criteria

1. ✅ All type definitions match spec exactly
2. ✅ Pydantic validation works (score bounds, required fields)
3. ✅ `create_initial_state()` returns valid BlogState
4. ✅ All tests pass: `uv run pytest test_state.py`
5. ✅ No mypy errors: `uv run mypy src/hvas_mini/state.py`
6. ✅ Docstrings explain each field's purpose

## Testing

```bash
cd worktrees/state-management
uv run pytest test_state.py -v
uv run mypy src/hvas_mini/state.py
```

## Integration Notes

This state will be used by:
- All agents (read/write content fields)
- Evaluator (write scores)
- Evolution system (write parameter_updates)
- Visualizer (read everything for display)
- LangGraph (orchestration)

## Next Steps

After completion, can merge to main and proceed with:
- feature/base-agent (will import and use BlogState)
- feature/evaluation-system (will import and use BlogState)
- feature/visualization (will import and use BlogState)
